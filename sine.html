<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>みんなの予定調整カレンダー</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide アイコンコンポーネント
        const LucideIcon = ({ name, className = "w-4 h-4" }) => {
            return React.createElement('i', { 
                'data-lucide': name, 
                className: className 
            });
        };

        const Calendar = (props) => <LucideIcon name="calendar" {...props} />;
        const Users = (props) => <LucideIcon name="users" {...props} />;
        const Plus = (props) => <LucideIcon name="plus" {...props} />;
        const Trash2 = (props) => <LucideIcon name="trash-2" {...props} />;
        const Check = (props) => <LucideIcon name="check" {...props} />;
        const Wifi = (props) => <LucideIcon name="wifi" {...props} />;
        const WifiOff = (props) => <LucideIcon name="wifi-off" {...props} />;

        const GroupSchedulePlanner = () => {
            const [members, setMembers] = useState([]);
            const [newMemberName, setNewMemberName] = useState('');
            const [schedules, setSchedules] = useState({});
            const [selectedMonth, setSelectedMonth] = useState(7); // 8月 (0-indexed)
            const [currentYear] = useState(2025);
            const [activeMemberChecks, setActiveMemberChecks] = useState({});
            const [isConnected, setIsConnected] = useState(false);

            // Firebase設定（画面の設定値を使用）
            const firebaseConfig = {
                apiKey: "AIzaSyDT9fgsKoXWHKxs7KvekjW-TfhvDhpfLCE",
                authDomain: "schedule-6491a.firebaseapp.com",
                databaseURL: "https://schedule-6491a-default-rtdb.firebaseio.com",
                projectId: "schedule-6491a",
                storageBucket: "schedule-6491a.appspot.com",
                messagingSenderId: "110166663347463",
                appId: "1:110166663347463:web:b1a49f12a3483ddcd53a3"
            };

            // Firebase初期化
            const initFirebase = () => {
                if (typeof firebase === 'undefined') {
                    console.warn('Firebase未接続: ローカルモードで動作します');
                    return null;
                }
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                return firebase.database();
            };

            const database = initFirebase();

            // アプリ起動時にFirebaseから読み込み
            useEffect(() => {
                if (database) {
                    setIsConnected(true);
                    
                    // データをリアルタイム取得
                    const dataRef = database.ref('scheduleData');
                    
                    const handleDataChange = (snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            setMembers(data.members || []);
                            setSchedules(data.schedules || {});
                            setActiveMemberChecks(data.activeMemberChecks || {});
                        }
                    };

                    dataRef.on('value', handleDataChange);
                    
                    return () => dataRef.off('value', handleDataChange);
                } else {
                    // Firebase未接続時は何もしない（ローカルストレージは使用不可）
                    console.log('Firebase未接続のため、データは保存されません');
                }
            }, [database]);

            // Firebaseにデータを保存
            const saveData = async (updates) => {
                const dataToSave = {
                    members,
                    schedules,
                    activeMemberChecks,
                    ...updates
                };

                if (database && isConnected) {
                    try {
                        await database.ref('scheduleData').set(dataToSave);
                    } catch (error) {
                        console.error('Firebase保存エラー:', error);
                    }
                }
            };

            // 月の日数を取得
            const getDaysInMonth = (year, month) => {
                return new Date(year, month + 1, 0).getDate();
            };

            // 月の最初の日の曜日を取得
            const getFirstDayOfMonth = (year, month) => {
                return new Date(year, month, 1).getDay();
            };

            // メンバー追加
            const addMember = () => {
                if (newMemberName.trim() && !members.includes(newMemberName.trim())) {
                    const newMember = newMemberName.trim();
                    const newMembers = [...members, newMember];
                    const newSchedules = { ...schedules };
                    const newChecks = { ...activeMemberChecks, [newMember]: true };
                    
                    if (!newSchedules[newMember]) {
                        newSchedules[newMember] = {};
                    }
                    
                    setMembers(newMembers);
                    setSchedules(newSchedules);
                    setActiveMemberChecks(newChecks);
                    setNewMemberName('');
                    
                    saveData({
                        members: newMembers,
                        schedules: newSchedules,
                        activeMemberChecks: newChecks
                    });
                }
            };

            // メンバー削除
            const removeMember = (memberName) => {
                const newMembers = members.filter(m => m !== memberName);
                const newSchedules = { ...schedules };
                const newChecks = { ...activeMemberChecks };
                
                delete newSchedules[memberName];
                delete newChecks[memberName];
                
                setMembers(newMembers);
                setSchedules(newSchedules);
                setActiveMemberChecks(newChecks);
                
                saveData({
                    members: newMembers,
                    schedules: newSchedules,
                    activeMemberChecks: newChecks
                });
            };

            // メンバーのチェック状態を切り替え
            const toggleMemberCheck = (memberName) => {
                const newChecks = {
                    ...activeMemberChecks,
                    [memberName]: !activeMemberChecks[memberName]
                };
                
                setActiveMemberChecks(newChecks);
                saveData({ activeMemberChecks: newChecks });
            };

            // 予定の切り替え（空き/忙しい）
            const toggleSchedule = (memberName, date) => {
                const dateKey = `${currentYear}-${selectedMonth + 1}-${date}`;
                const newSchedules = { ...schedules };
                
                if (!newSchedules[memberName]) {
                    newSchedules[memberName] = {};
                }
                
                newSchedules[memberName][dateKey] = !newSchedules[memberName][dateKey];
                setSchedules(newSchedules);
                saveData({ schedules: newSchedules });
            };

            // 指定日にチェックされたメンバーが空いているかチェック
            const isEveryoneFree = (date) => {
                const activeMembers = members.filter(member => activeMemberChecks[member]);
                if (activeMembers.length === 0) return false;
                
                const dateKey = `${currentYear}-${selectedMonth + 1}-${date}`;
                return activeMembers.every(member => {
                    const memberSchedule = schedules[member];
                    return !memberSchedule || !memberSchedule[dateKey];
                });
            };

            // メンバーが指定日に忙しいかチェック
            const isMemberBusy = (memberName, date) => {
                const dateKey = `${currentYear}-${selectedMonth + 1}-${date}`;
                return schedules[memberName] && schedules[memberName][dateKey];
            };

            // カレンダーの描画
            const renderCalendar = () => {
                const daysInMonth = getDaysInMonth(currentYear, selectedMonth);
                const firstDay = getFirstDayOfMonth(currentYear, selectedMonth);
                const days = [];
                
                // 空のセルを追加（月の最初の日まで）
                for (let i = 0; i < firstDay; i++) {
                    days.push(React.createElement('div', { key: `empty-${i}`, className: "h-8" }));
                }
                
                // 日付のセルを追加
                for (let date = 1; date <= daysInMonth; date++) {
                    const isAllFree = isEveryoneFree(date);
                    const today = new Date();
                    const isToday = today.getFullYear() === currentYear && 
                                   today.getMonth() === selectedMonth && 
                                   today.getDate() === date;
                    
                    days.push(
                        React.createElement('div', { key: date, className: "relative" },
                            React.createElement('div', {
                                className: `h-8 w-8 flex items-center justify-center rounded text-sm font-medium cursor-pointer transition-all ${
                                    isToday ? 'ring-2 ring-blue-500' : ''
                                } ${
                                    isAllFree ? 'bg-green-100 text-green-800 shadow-md' : 'bg-gray-50 hover:bg-gray-100'
                                }`
                            }, 
                                date,
                                isAllFree && React.createElement(Check, { 
                                    className: "absolute -top-1 -right-1 w-3 h-3 text-green-600 bg-white rounded-full" 
                                })
                            )
                        )
                    );
                }
                
                return days;
            };

            const monthNames = [
                '1月', '2月', '3月', '4月', '5月', '6月',
                '7月', '8月', '9月', '10月', '11月', '12月'
            ];

            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];

            return React.createElement('div', { className: "max-w-6xl mx-auto p-6 bg-white" },
                // タイトル
                React.createElement('div', { className: "text-center mb-8" },
                    React.createElement('h1', { className: "text-3xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-2" },
                        React.createElement(Calendar, { className: "w-8 h-8 text-blue-600" }),
                        "みんなの予定調整カレンダー"
                    ),
                    React.createElement('p', { className: "text-gray-600" }, 
                        "遊びに行けない日をマークして、みんなが空いている日を見つけよう！"
                    ),
                    // 接続状態表示
                    React.createElement('div', { className: "mt-4 flex items-center justify-center gap-2 text-sm" },
                        isConnected ? [
                            React.createElement(Wifi, { key: "wifi", className: "w-4 h-4 text-green-600" }),
                            React.createElement('span', { key: "text", className: "text-green-600" }, "Firebase接続中 - リアルタイム同期")
                        ] : [
                            React.createElement(WifiOff, { key: "wifi-off", className: "w-4 h-4 text-orange-600" }),
                            React.createElement('span', { key: "text", className: "text-orange-600" }, "Firebase未接続 - データは保存されません")
                        ]
                    )
                ),

                // メンバー管理
                React.createElement('div', { className: "mb-8 p-6 bg-gray-50 rounded-lg" },
                    React.createElement('h2', { className: "text-xl font-semibold mb-4 flex items-center gap-2" },
                        React.createElement(Users, { className: "w-5 h-5" }),
                        "メンバー管理"
                    ),
                    React.createElement('div', { className: "flex gap-2 mb-4" },
                        React.createElement('input', {
                            type: "text",
                            value: newMemberName,
                            onChange: (e) => setNewMemberName(e.target.value),
                            placeholder: "名前を入力",
                            className: "flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                            onKeyPress: (e) => e.key === 'Enter' && addMember()
                        }),
                        React.createElement('button', {
                            onClick: addMember,
                            className: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center gap-1"
                        },
                            React.createElement(Plus, { className: "w-4 h-4" }),
                            "追加"
                        )
                    ),
                    React.createElement('div', { className: "flex flex-wrap gap-2" },
                        members.map(member =>
                            React.createElement('div', { 
                                key: member, 
                                className: "flex items-center gap-2 bg-white px-3 py-2 rounded-lg border" 
                            },
                                React.createElement('input', {
                                    type: "checkbox",
                                    checked: activeMemberChecks[member] || false,
                                    onChange: () => toggleMemberCheck(member),
                                    className: "w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                }),
                                React.createElement('span', { 
                                    className: activeMemberChecks[member] ? 'text-gray-900' : 'text-gray-400 line-through' 
                                }, member),
                                React.createElement('button', {
                                    onClick: () => removeMember(member),
                                    className: "text-red-500 hover:text-red-700 ml-1"
                                },
                                    React.createElement(Trash2, { className: "w-4 h-4" })
                                )
                            )
                        )
                    ),
                    members.length > 0 && React.createElement('div', { className: "mt-3 text-sm text-gray-600" },
                        `チェックしたメンバー (${members.filter(m => activeMemberChecks[m]).length}人) の空いている日を表示中`
                    )
                ),

                // 月選択
                React.createElement('div', { className: "mb-6 text-center" },
                    React.createElement('select', {
                        value: selectedMonth,
                        onChange: (e) => setSelectedMonth(parseInt(e.target.value)),
                        className: "px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg font-medium"
                    },
                        monthNames.map((month, index) =>
                            React.createElement('option', { key: index, value: index },
                                `${currentYear}年 ${month}`
                            )
                        )
                    )
                ),

                // カレンダー表示
                React.createElement('div', { className: "mb-8" },
                    React.createElement('div', { className: "bg-white border border-gray-200 rounded-lg p-4" },
                        React.createElement('div', { className: "grid grid-cols-7 gap-2 mb-4" },
                            weekdays.map(day =>
                                React.createElement('div', { 
                                    key: day, 
                                    className: "text-center font-medium text-gray-700 py-2" 
                                }, day)
                            )
                        ),
                        React.createElement('div', { className: "grid grid-cols-7 gap-2" },
                            renderCalendar()
                        ),
                        React.createElement('div', { className: "mt-4 flex items-center gap-4 text-sm" },
                            React.createElement('div', { className: "flex items-center gap-1" },
                                React.createElement('div', { className: "w-4 h-4 bg-green-100 border border-green-300 rounded" }),
                                React.createElement('span', {}, "選択メンバーみんな空いてる日")
                            ),
                            React.createElement('div', { className: "flex items-center gap-1" },
                                React.createElement(Check, { className: "w-4 h-4 text-green-600" }),
                                React.createElement('span', {}, "おすすめの日")
                            )
                        )
                    )
                ),

                // 個別スケジュール入力
                members.length > 0 && React.createElement('div', { className: "space-y-6" },
                    React.createElement('h2', { className: "text-xl font-semibold" }, "個別スケジュール入力"),
                    members.map(member =>
                        React.createElement('div', { 
                            key: member, 
                            className: "p-4 border border-gray-200 rounded-lg" 
                        },
                            React.createElement('h3', { className: "font-medium mb-3" }, `${member}さんの予定`),
                            React.createElement('div', { className: "grid grid-cols-7 gap-1" },
                                Array.from({ length: getDaysInMonth(currentYear, selectedMonth) }, (_, i) => {
                                    const date = i + 1;
                                    const isBusy = isMemberBusy(member, date);
                                    
                                    return React.createElement('button', {
                                        key: date,
                                        onClick: () => toggleSchedule(member, date),
                                        className: `h-10 w-10 text-xs rounded transition-all border ${
                                            isBusy 
                                                ? 'bg-red-100 border-red-300 text-red-700 hover:bg-red-200' 
                                                : 'bg-green-50 border-green-200 text-green-700 hover:bg-green-100'
                                        }`
                                    }, date);
                                })
                            ),
                            React.createElement('p', { className: "text-xs text-gray-600 mt-2" },
                                "クリックで切り替え: ",
                                React.createElement('span', { className: "text-green-600 ml-1" }, "緑=空いてる"),
                                React.createElement('span', { className: "text-red-600 ml-2" }, "赤=忙しい")
                            )
                        )
                    )
                ),

                // メンバーなしの場合
                members.length === 0 && React.createElement('div', { className: "text-center py-12 text-gray-500" },
                    React.createElement(Users, { className: "w-12 h-12 mx-auto mb-4 opacity-50" }),
                    React.createElement('p', {}, "メンバーを追加して予定調整を始めましょう！")
                )
            );
        };

        // アプリをレンダリング
        ReactDOM.render(React.createElement(GroupSchedulePlanner), document.getElementById('root'));

        // Lucide アイコンを初期化
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</body>
</html>